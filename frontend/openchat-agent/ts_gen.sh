#!/bin/bash

SCRIPT=$(readlink -f "$0")
SCRIPT_DIR=$(dirname "$SCRIPT")
cd $SCRIPT_DIR

mergedFile=./src/tsBindingsMerged.ts
zodFile=./src/zod.ts

echo "// Autogenerated by \`ts_gen.sh\`. Do not edit manually" > $mergedFile

for filename in $(find ./tsBindings -name '*.ts'); do
    [ -e "$filename" ] || continue

    cat $filename | while read line
    do
        if [[ $line == export* ]]; then
            echo $line >> $mergedFile
        fi
    done
done

npm run ts-to-zod $mergedFile $zodFile

sed -i.bak 's/z.bigint()/z.coerce.bigint()/g' $zodFile
rm ./src/zod.ts.bak
