<script lang="ts">
    import Button from "../Button.svelte";
    import Input from "../Input.svelte";
    import { fade } from "svelte/transition";
    import { createEventDispatcher } from "svelte";
    const dispatch = createEventDispatcher();
    import { _ } from "svelte-i18n";
    import { phoneNumberToString } from "../../domain/user/user.utils";
    import type { PhoneNumber } from "../../domain/user/user";
    import Link from "../Link.svelte";

    export let phoneNumber: PhoneNumber;
    export let error: string | undefined = undefined;

    let codeValue: string = "";

    function submitCode() {
        if (valid) {
            dispatch("submitCode", { code: codeValue, phoneNumber });
        }
    }

    function resendCode() {
        dispatch("resendCode", { phoneNumber });
    }

    function changePhoneNumber() {
        dispatch("changePhoneNumber");
    }

    $: valid = codeValue.length === 6;
</script>

<h3 class="title">
    {$_("register.pleaseEnterCode")}
</h3>

<p class="enter-code">
    <span>
        {$_("register.enterCodeSentTo")}
    </span>
    <span class="phone-number">{phoneNumberToString(phoneNumber)}</span>
    <span>
        <Link underline={"always"} on:click={changePhoneNumber}>({$_("change")})</Link>
    </span>
</p>

<form class="code-wrapper" on:submit|preventDefault={submitCode}>
    <Input
        invalid={error !== undefined}
        align="center"
        fontSize="large"
        autofocus={true}
        bind:value={codeValue}
        minlength={6}
        maxlength={6}
        placeholder={$_("register.enterCode")} />
</form>

{#if error}
    <h4 in:fade class="error">{$_(error)}</h4>
{/if}

<div class="actions">
    <Button disabled={!valid} on:click={submitCode}>{$_("register.validateCode")}</Button>
    <Button secondary={true} on:click={resendCode}>{$_("register.resendCode")}</Button>
</div>

<style type="text/scss">
    .actions {
        display: flex;
        gap: $sp3;

        @include size-below(xs) {
            flex-direction: column;
        }
    }

    .error {
        @include font(bold, normal, fs-100);
        color: var(--error);
        margin-bottom: $sp4;
    }

    .enter-code {
        @include font(light, normal, fs-100);
        margin-bottom: $sp4;
    }

    .phone-number {
        @include font(bold, normal, fs-100);
    }

    .code-wrapper {
        max-width: 200px;
    }

    .title {
        @include font(bold, normal, fs-160);
        margin: $sp3 $sp4;
        text-align: center;
        text-shadow: var(--modalPage-txt-sh);
    }
</style>
